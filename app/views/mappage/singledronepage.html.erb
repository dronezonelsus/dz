<script src="//maps.google.com/maps/api/js?key=AIzaSyA2b6Qe48bvmxyYCCr1sA1QqrXCG8dJuYk"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->
<div class="row">
	<div id="map" class="pos col-lg-8 col-md-7 col-sm-12" style='height: 700px;'> 

		
		<script type="text/javascript">

			//Build Google Maps using Gmaps
			var handler = Gmaps.build('Google', { markers: {}});
			var markers = [];
			//Load initial markers (drones) on the map by calling the initial_load() function
			$(document).ready(function(){
				initial_load();	
				//Call ajax function (auto_load()) every 5 seconds
				//setInterval(auto_load, 5000);
			});

			//Load initial markers (drones) on the map 
			function initial_load(){	
				$.ajax({
					type: "GET",
					url: "<%= Rails.application.routes.url_helpers.mappage_singledronepage_path %>",
					cache: true,
					contentType: 'application/json',
					dataType: "json",
					data: <%= raw @lasthash.to_json %>,
					success: function(result){  
						console.log(result);
						// handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
						// 	markers = handler.addMarkers(<%= raw @parsed_drone.to_json %>); 		
						// 	handler.bounds.extendWith(markers);
						// 	handler.fitMapToBounds(markers);	

						// 	_.each(result, function(json, index){
					 // 			var marker = markers[index];
					 // 			json.marker = marker;
					 // 			google.maps.event.addListener(marker.getServiceObject(), 'mouseover', function(){
					 //          		google.maps.event.trigger(marker.getServiceObject(), 'click');
					 //        	});
				 	// 		});

						// });
  					},
  					error: function(XMLHttpResquestm, textStatus, errorThrown){
  						console.log(textStatus, errorThrown);
  					}
    			});
	    	};
		</script>
</div>
</div>