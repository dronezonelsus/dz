<script src="//maps.google.com/maps/api/js?key=AIzaSyA2b6Qe48bvmxyYCCr1sA1QqrXCG8dJuYk"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->
<div class="row">
	<div id="map" class="pos col-lg-8 col-md-7 col-sm-12" style='height: 700px;'> 
		
		<script type="text/javascript">

			//Build Google Maps using Gmaps
			var handler = Gmaps.build('Google', { markers: {}});

			//Load initial markers (drones) on the map by calling the initial_load() function
			$(document).ready(function(){
				initial_load();
				
				//Call ajax function (auto_load()) every 5 seconds
				//setInterval(auto_load, 5000);
			});

			//Load initial markers (drones) on the map 
			function initial_load(){	
				markers = [];
					$.ajax({
						type: "GET",
						url: "<%= Rails.application.routes.url_helpers.mappage_index_path %>",
						cache: false,
						contentType: 'application/json',
						dataType: "json",
						data: <%= @hash.to_json %>,
						success: function(result){  
							//console.log(JSON.stringify(result));	
							//var my_result = JSON.stringify(result);
							handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){

								markers = handler.addMarkers(result); 		
								for (var j = 0; j < markers.length; j++) {
									var marker = markers[j];
								google.maps.event.addListener(marker.getServiceObject(), 'click', function(evt) {
							  		//$("#drone_name").html("lat: " + result[0].lat);
							  		//$("#drone_name").empty()
							  		alert("hello!");
							  		window.open("");
								});
								}		
							handler.bounds.extendWith(markers);
							handler.fitMapToBounds(markers);	
						});
	  					},
	  					error: function(XMLHttpResquestm, textStatus, errorThrown){
	  						console.log(textStatus, errorThrown);
	  					}
	    			});
			};
		</script>
</div>
</div>